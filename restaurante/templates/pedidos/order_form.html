{% extends "base.html" %}
{% block content %}

<h1>Crear Pedido</h1>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<form method="post" novalidate>
  {% csrf_token %}

  <div class="row mb-3">
    <div class="col-md-3">
      {{ form.tipo.label_tag }}
      {{ form.tipo }}
      {% if form.tipo.errors %}<div class="text-danger">{{ form.tipo.errors }}</div>{% endif %}
    </div>

    <div class="col-md-3">
      {{ form.estado.label_tag }}
      {{ form.estado }}
      {% if form.estado.errors %}<div class="text-danger">{{ form.estado.errors }}</div>{% endif %}
    </div>

    <div class="col-md-3">
      {{ form.mesa.label_tag }}
      {{ form.mesa }}
      {% if form.mesa.errors %}<div class="text-danger">{{ form.mesa.errors }}</div>{% endif %}
    </div>

    <div class="col-md-3">
      {{ form.cliente_nombre.label_tag }}
      {{ form.cliente_nombre }}
      {% if form.cliente_nombre.errors %}<div class="text-danger">{{ form.cliente_nombre.errors }}</div>{% endif %}
    </div>
  </div>

  <h4>Detalles del Pedido</h4>
  <p class="text-muted">Complete al menos un producto para registrar la venta</p>

  {{ formset.management_form }}

  {% if formset.non_form_errors %}
    <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
  {% endif %}

  <table class="table table-sm table-bordered" id="detalles-table">
    <thead class="table-light">
      <tr>
        <th style="width: 40%;">Producto</th>
        <th style="width: 15%;">Cantidad</th>
        <th style="width: 15%;">Precio unitario</th>
        <th style="width: 15%;">Subtotal</th>
        <th style="width: 15%;">Eliminar</th>
      </tr>
    </thead>
    <tbody>
      {% for form in formset %}
        <tr class="detalle-row">
          <td>
            <select name="{{ form.producto.html_name }}" class="form-control producto-select">
              <option value="">---------</option>
              {% for p in productos %}
                <option value="{{ p.id }}" data-precio="{{ p.precio }}"
                  {% if form.producto.value|stringformat:"s" == p.id|stringformat:"s" %}selected{% endif %}>
                  {{ p.nombre }} — {{ p.precio }} Bs.
                </option>
              {% endfor %}
            </select>
            {{ form.id }}
          </td>
          <td>{{ form.cantidad }}</td>
          <td>{{ form.precio_unitario }}</td>
          <td class="subtotal-cell align-middle">$0.00</td>
          <td class="text-center">{{ form.DELETE }}</td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="3" class="text-end fw-bold">TOTAL:</td>
        <td colspan="2" class="fw-bold" id="total-general">$0.00</td>
      </tr>
    </tfoot>
  </table>

  <button type="button" class="btn btn-success mb-3" id="add-product">
    <i class="bi bi-plus-circle"></i> Agregar producto
  </button>

  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary">
      <i class="bi bi-check-circle"></i> Finalizar venta
    </button>
    <a href="{% url 'lista_pedidos' %}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>

<!-- Fila vacía oculta para JS -->
<table style="display:none">
  <tbody>
    <tr id="empty-row">
      <td>
        <select class="form-control producto-select">
          <option value="">---------</option>
          {% for p in productos %}
            <option value="{{ p.id }}" data-precio="{{ p.precio }}">{{ p.nombre }} — {{ p.precio }} Bs.</option>
          {% endfor %}
        </select>
        <input type="hidden" name="detallepedido_set-__prefix__-id" value="">
      </td>
      <td><input type="number" name="detallepedido_set-__prefix__-cantidad" class="form-control" min="1"></td>
      <td><input type="number" name="detallepedido_set-__prefix__-precio_unitario" class="form-control" step="0.01"></td>
      <td class="subtotal-cell">0.00Bs</td>
      <td class="text-center"><input type="checkbox" name="detallepedido_set-__prefix__-DELETE"></td>
    </tr>
  </tbody>
</table>

<script>
function parseFloatSafe(v){
  v = String(v).replace(',', '.');
  var n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}

function actualizarSubtotal(row){
  var cantidadInput = row.querySelector('[name$="-cantidad"]');
  var precioInput = row.querySelector('[name$="-precio_unitario"]');
  if(!cantidadInput || !precioInput) return;
  var cantidad = parseFloatSafe(cantidadInput.value);
  var precio = parseFloatSafe(precioInput.value);
  row.querySelector('.subtotal-cell').textContent = 'Bs' + (cantidad*precio).toFixed(2);
  actualizarTotal();
}

function actualizarTotal(){
  var total = 0;
  document.querySelectorAll('.detalle-row').forEach(function(row){
    var deleteCheckbox = row.querySelector('[name$="-DELETE"]');
    if(deleteCheckbox && deleteCheckbox.checked) return;
    var cantidad = parseFloatSafe(row.querySelector('[name$="-cantidad"]').value);
    var precio = parseFloatSafe(row.querySelector('[name$="-precio_unitario"]').value);
    total += cantidad * precio;
  });
  document.getElementById('total-general').textContent = 'Bs' + total.toFixed(2);
}

// Actualiza subtotales al cambiar cantidad o precio
document.addEventListener('input', function(e){
  if(e.target.matches('[name$="-cantidad"], [name$="-precio_unitario"]')){
    actualizarSubtotal(e.target.closest('.detalle-row'));
  }
});

// Cuando cambia producto o DELETE
document.addEventListener('change', function(e){
  if(e.target.matches('[name$="-producto"]')){
    var sel = e.target;
    var precio = sel.options[sel.selectedIndex].dataset.precio;
    if(precio){
      var row = sel.closest('.detalle-row');
      row.querySelector('[name$="-precio_unitario"]').value = precio;
      actualizarSubtotal(row);
    }
  }
  if(e.target.matches('[name$="-DELETE"]')){
    actualizarTotal();
  }
});

// Inicializa subtotales al cargar
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.detalle-row').forEach(actualizarSubtotal);
});

// Botón agregar producto
document.getElementById('add-product').addEventListener('click', function(){
  const totalForms = document.querySelector('input[name$="-TOTAL_FORMS"]');
  const emptyRow = document.querySelector('#empty-row');
  const newRow = emptyRow.cloneNode(true);
  let formIndex = parseInt(totalForms.value);

  newRow.removeAttribute('id');
  newRow.style.display = '';
  newRow.querySelectorAll('input, select').forEach(function(el){
    if(el.name) el.name = el.name.replace('__prefix__', formIndex);
    if(el.id) el.id = el.id.replace('__prefix__', formIndex);
    if(el.tagName==='INPUT') el.value = '';
    if(el.tagName==='SELECT') el.selectedIndex=0;
  });

  document.querySelector('#detalles-table tbody').appendChild(newRow);
  totalForms.value = formIndex + 1;
});
</script>

{% endblock %}
