{% extends "base.html" %}
{% block content %}

<h1>Crear Pedido</h1>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<form method="post" novalidate id="pedido-form">
  {% csrf_token %}

  <div class="row mb-3">
    <div class="col-md-3">
      {{ form.tipo.label_tag }}
      {{ form.tipo }}
      {% if form.tipo.errors %}<div class="text-danger">{{ form.tipo.errors }}</div>{% endif %}
    </div>

    <div class="col-md-3">
      {{ form.estado.label_tag }}
      {{ form.estado }}
      {% if form.estado.errors %}<div class="text-danger">{{ form.estado.errors }}</div>{% endif %}
    </div>

    <div class="col-md-3">
      {{ form.mesa.label_tag }}
      {{ form.mesa }}
      {% if form.mesa.errors %}<div class="text-danger">{{ form.mesa.errors }}</div>{% endif %}
    </div>

    <div class="col-md-3">
      {{ form.cliente_nombre.label_tag }}
      {{ form.cliente_nombre }}
      {% if form.cliente_nombre.errors %}<div class="text-danger">{{ form.cliente_nombre.errors }}</div>{% endif %}
    </div>
  </div>

  <h4>Detalles del Pedido</h4>
  <p class="text-muted">Complete al menos un producto para registrar la venta</p>

  {{ formset.management_form }}

  {% if formset.non_form_errors %}
    <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
  {% endif %}

  <table class="table table-sm table-bordered" id="detalles-table">
    <thead class="table-light">
      <tr>
        <th style="width: 40%;">Producto</th>
        <th style="width: 15%;">Cantidad</th>
        <th style="width: 15%;">Precio unitario</th>
        <th style="width: 15%;">Subtotal</th>
        <th style="width: 15%;">Eliminar</th>
      </tr>
    </thead>
    <tbody id="detalles-tbody">
      {% for form in formset %}
        <tr class="detalle-row" data-form-index="{{ forloop.counter0 }}">
          <td>
            {{ form.id }}
            <select name="{{ form.producto.html_name }}" id="id_{{ form.producto.html_name }}" class="form-control producto-select">
              <option value="">---------</option>
              {% for p in productos %}
                <option value="{{ p.id }}" data-precio="{{ p.precio }}"
                  {% if form.producto.value|stringformat:"s" == p.id|stringformat:"s" %}selected{% endif %}>
                  {{ p.nombre }} — {{ p.precio }} Bs.
                </option>
              {% endfor %}
            </select>
            {% if form.producto.errors %}<div class="text-danger small">{{ form.producto.errors }}</div>{% endif %}
          </td>
          <td>
            {{ form.cantidad }}
            {% if form.cantidad.errors %}<div class="text-danger small">{{ form.cantidad.errors }}</div>{% endif %}
          </td>
          <td>
            {{ form.precio_unitario }}
            {% if form.precio_unitario.errors %}<div class="text-danger small">{{ form.precio_unitario.errors }}</div>{% endif %}
          </td>
          <td class="subtotal-cell align-middle">Bs0.00</td>
          <td class="text-center">{{ form.DELETE }}</td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="3" class="text-end fw-bold">TOTAL:</td>
        <td colspan="2" class="fw-bold" id="total-general">Bs0.00</td>
      </tr>
    </tfoot>
  </table>

  <button type="button" class="btn btn-success mb-3" id="add-product">
    <i class="bi bi-plus-circle"></i> Agregar producto
  </button>

  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary">
      <i class="bi bi-check-circle"></i> Finalizar venta
    </button>
    <a href="{% url 'lista_pedidos' %}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>

<!-- Fila vacía oculta para JS — usa formset.prefix para mantener consistencia -->
<table style="display:none">
  <tbody>
    <tr id="empty-row" class="detalle-row">
      <td>
        <input type="hidden" name="{{ formset.prefix }}-__prefix__-id" id="id_{{ formset.prefix }}-__prefix__-id" value="">
        <select name="{{ formset.prefix }}-__prefix__-producto" id="id_{{ formset.prefix }}-__prefix__-producto" class="form-control producto-select">
          <option value="">---------</option>
          {% for p in productos %}
            <option value="{{ p.id }}" data-precio="{{ p.precio }}">{{ p.nombre }} — {{ p.precio }} Bs.</option>
          {% endfor %}
        </select>
      </td>
      <td><input type="number" name="{{ formset.prefix }}-__prefix__-cantidad" id="id_{{ formset.prefix }}-__prefix__-cantidad" class="form-control" min="1" value="1"></td>
      <td><input type="number" name="{{ formset.prefix }}-__prefix__-precio_unitario" id="id_{{ formset.prefix }}-__prefix__-precio_unitario" class="form-control" step="0.01" value="0"></td>
      <td class="subtotal-cell align-middle">Bs0.00</td>
      <td class="text-center"><input type="checkbox" name="{{ formset.prefix }}-__prefix__-DELETE" id="id_{{ formset.prefix }}-__prefix__-DELETE"></td>
    </tr>
  </tbody>
</table>

<script>


function parseFloatSafe(v){
  v = String(v ?? '').replace(',', '.');
  var n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}

function actualizarSubtotal(row){
  var cantidadInput = row.querySelector('[name$="-cantidad"]');
  var precioInput = row.querySelector('[name$="-precio_unitario"]');
  if(!cantidadInput || !precioInput) return;
  var cantidad = parseFloatSafe(cantidadInput.value);
  var precio = parseFloatSafe(precioInput.value);
  var subtotal = cantidad * precio;
  var cell = row.querySelector('.subtotal-cell');
  if(cell) cell.textContent = 'Bs' + subtotal.toFixed(2);
  actualizarTotal();
}

function actualizarTotal(){
  var total = 0;
  document.querySelectorAll('.detalle-row').forEach(function(row){
    if(row.id === 'empty-row') return;
    var deleteCheckbox = row.querySelector('[name$="-DELETE"]');
    if(deleteCheckbox && deleteCheckbox.checked) return;
    var cantidadInput = row.querySelector('[name$="-cantidad"]');
    var precioInput = row.querySelector('[name$="-precio_unitario"]');
    if(!cantidadInput || !precioInput) return;
    total += parseFloatSafe(cantidadInput.value) * parseFloatSafe(precioInput.value);
  });
  var totalEl = document.getElementById('total-general');
  if(totalEl) totalEl.textContent = 'Bs' + total.toFixed(2);
}

function getManagementInputs() {
  var prefix = "{{ formset.prefix }}";
  return {
    prefix: prefix,
    TOTAL_FORMS: document.querySelector('input[name="'+prefix+'-TOTAL_FORMS"]'),
    INITIAL_FORMS: document.querySelector('input[name="'+prefix+'-INITIAL_FORMS"]'),
    MIN_NUM_FORMS: document.querySelector('input[name="'+prefix+'-MIN_NUM_FORMS"]'),
    MAX_NUM_FORMS: document.querySelector('input[name="'+prefix+'-MAX_NUM_FORMS"]')
  };
}

document.getElementById('add-product').addEventListener('click', function(){
  const mg = getManagementInputs();
  if(!mg.TOTAL_FORMS) {
    alert('Error: no se encontró TOTAL_FORMS en el formulario.');
    return;
  }

  const emptyRow = document.querySelector('#empty-row');
  const tbody = document.getElementById('detalles-tbody');
  if(!emptyRow || !tbody) return;

  let formIndex = parseInt(mg.TOTAL_FORMS.value, 10);
  const newRow = emptyRow.cloneNode(true);

  newRow.removeAttribute('id');
  newRow.classList.add('detalle-row');
  newRow.setAttribute('data-form-index', formIndex);

  newRow.querySelectorAll('input, select').forEach(function(el){
    if(el.name) el.name = el.name.replace(/__prefix__/g, formIndex);
    if(el.id) el.id = el.id.replace(/__prefix__/g, formIndex);

    if(el.tagName === 'INPUT' && el.type !== 'hidden' && el.type !== 'checkbox') {
      if(el.name.includes('-cantidad')) el.value = '1';
      else if(el.name.includes('-precio_unitario')) el.value = '0';
      else el.value = '';
    }
    if(el.tagName === 'INPUT' && el.type === 'checkbox') el.checked = false;
    if(el.tagName === 'SELECT') el.selectedIndex = 0;
  });

  tbody.appendChild(newRow);
  mg.TOTAL_FORMS.value = formIndex + 1;
  actualizarSubtotal(newRow);
});

document.addEventListener('input', function(e){
  if(e.target.matches('[name$="-cantidad"], [name$="-precio_unitario"]')){
    var row = e.target.closest('.detalle-row');
    if(row && row.id !== 'empty-row') actualizarSubtotal(row);
  }
});

document.addEventListener('change', function(e){
  if(e.target.matches('[name$="-producto"]')){
    var sel = e.target;
    var selectedOption = sel.options[sel.selectedIndex];
    var precio = selectedOption ? selectedOption.dataset.precio : null;
    if(precio){
      var row = sel.closest('.detalle-row');
      if(row && row.id !== 'empty-row'){
        var precioInput = row.querySelector('[name$="-precio_unitario"]');
        if(precioInput) {
          precioInput.value = precio;
          actualizarSubtotal(row);
        }
      }
    }
  }
  if(e.target.matches('[name$="-DELETE"]')){
    actualizarTotal();
  }
});

document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.detalle-row').forEach(function(row){
    if(row.id !== 'empty-row') actualizarSubtotal(row);
  });
});

document.getElementById('pedido-form').addEventListener('submit', function(){
  const mg = getManagementInputs();
  if(!mg.TOTAL_FORMS) return;

  var filas = Array.from(document.querySelectorAll('.detalle-row')).filter(function(r){ return r.id !== 'empty-row'; });

  filas.forEach(function(row, idx){
    row.setAttribute('data-form-index', idx);
    row.querySelectorAll('input, select').forEach(function(el){
      if(el.name) el.name = el.name.replace(/(\d+|__prefix__)/g, idx);
      if(el.id) el.id = el.id.replace(/(\d+|__prefix__)/g, idx);
    });
  });

  mg.TOTAL_FORMS.value = filas.length;
});
</script>
{% endblock %}
